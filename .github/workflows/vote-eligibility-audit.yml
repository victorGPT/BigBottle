name: Vote Eligibility Audit

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      effective_round_id:
        description: Optional positive integer as string. If empty, resolve automatically from DB.
        required: false
        type: string
  schedule:
    - cron: "0 */3 * * *"

jobs:
  audit-vote-eligibility:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ secrets.SUPABASE_DB_URL }}
      DEFAULT_EFFECTIVE_ROUND_ID: ${{ vars.VEBETTER_CURRENT_EFFECTIVE_ROUND_ID || '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install postgresql-client
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Resolve effective round id
        id: resolve_round
        env:
          INPUT_EFFECTIVE_ROUND_ID: ${{ github.event.inputs.effective_round_id || '' }}
        run: |
          set -euo pipefail

          if [[ -z "${DATABASE_URL:-}" ]]; then
            echo "DATABASE_URL is empty. Please set repository secret SUPABASE_DB_URL." >&2
            exit 1
          fi

          if [[ -n "${INPUT_EFFECTIVE_ROUND_ID}" ]]; then
            resolved_round_id="${INPUT_EFFECTIVE_ROUND_ID}"
            echo "Using provided effective_round_id=${resolved_round_id}"
          elif [[ -n "${DEFAULT_EFFECTIVE_ROUND_ID}" ]]; then
            resolved_round_id="${DEFAULT_EFFECTIVE_ROUND_ID}"
            echo "Using repo variable VEBETTER_CURRENT_EFFECTIVE_ROUND_ID=${resolved_round_id}"
          else
            resolved_round_id="$(psql -X "${DATABASE_URL}" -v ON_ERROR_STOP=1 -Atqc "with maxes as (select coalesce((select max(effective_round_id) from public.bigbottle_vote_bonus_eligibility where bonus_type='vebetter_vote_bonus'),0) as max_effective_round, coalesce((select max(round_id) from public.vote_wallet_mapping where voted_any_app=true),0) as max_source_round) select case when max_source_round > 0 then greatest(max_effective_round, max_source_round + 1) else max_effective_round end from maxes;")"
            echo "Auto-resolved effective_round_id=${resolved_round_id}"
          fi

          if ! [[ "${resolved_round_id}" =~ ^[1-9][0-9]*$ ]]; then
            echo "Failed to resolve a positive effective_round_id (got '${resolved_round_id}'). Set repo variable VEBETTER_CURRENT_EFFECTIVE_ROUND_ID (e.g. 87) or re-run workflow_dispatch with effective_round_id." >&2
            exit 1
          fi

          echo "effective_round_id=${resolved_round_id}" >> "${GITHUB_OUTPUT}"

      - name: Audit vote eligibility consistency
        env:
          EFFECTIVE_ROUND_ID: ${{ steps.resolve_round.outputs.effective_round_id }}
        run: |
          set -euo pipefail
          bash scripts/ci/check_vote_eligibility.sh
